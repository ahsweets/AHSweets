<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>AH Sweets Management</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e1e1e">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
    --primary: #059669;
    --success: #FFC107;
    --bg: #1e1e1e;
    --card: #2c2c2c;
    --text-dark: #e5e7eb;
    --text-light: #9ca3af;
    --border: #374151;
    --receive-red: #ef4444;
}

body { background-color: var(--bg); margin: 0; padding: 0; display: flex; justify-content: center; }

#management-app {
    font-family: 'Inter', sans-serif;
    color: var(--text-dark);
    max-width: 600px;
    width: 100%;
    margin: 10px 10px;
    padding: 15px;
    padding-right: 40px; 
    border-radius: 16px;
    box-sizing: border-box;
}

.header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.header-title { font-weight: 700; font-size: 1.1rem; color: var(--success); }

#privacy-toggle { cursor: pointer; font-size: 1.2rem; margin-left: 10px; }

.search-container {
    position: sticky;
    top: 0;
    z-index: 1001;
    background: var(--bg);
    padding: 5px 0 10px 0;
}

#customerSearch {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--border);
    border-radius: 10px;
    background: #2c2c2c;
    color: white;
    font-size: 1rem;
    box-sizing: border-box;
}

.search-results {
    background: #333;
    border-radius: 0 0 10px 10px;
    max-height: 250px;
    overflow-y: auto;
    display: none;
    border: 1px solid var(--border);
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}

.search-results div { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; color: var(--success); }

.alpha-nav {
    position: fixed;
    right: 2px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    z-index: 1000;
    background: rgba(30, 30, 30, 0.85);
    padding: 5px 0;
    border-radius: 10px;
    max-height: 90vh;
    overflow-y: auto;
}

.alpha-nav a { font-size: 11px; color: var(--success); padding: 1px 6px; text-decoration: none; text-align: center; font-weight: 700; display: block; line-height: 1.4; }

.letter-header {
    color: var(--success);
    font-size: 1.2rem;
    font-weight: 800;
    padding: 10px 0 5px 0;
    border-bottom: 1px solid var(--border);
    margin-top: 15px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: row;
    align-items: center;
}

.total-credit-grey {
    color: #888;
    font-size: 1rem;
    font-weight: 500;
    margin-left: 8px;
    cursor: pointer;
}

.customer-box { background: var(--card); padding: 18px; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); scroll-margin-top: 150px; }
.customer-name { font-weight: 700; font-size: 1.1rem; color: var(--text-dark); cursor: pointer; }
.total-amount { font-weight: 800; font-size: 1.3rem; color: var(--success); margin: 5px 0; display: block; cursor: pointer; }

.input-box { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin: 10px 0; font-size: 1rem; box-sizing: border-box; background: #2c2c2c; color: var(--text-dark); }

.button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

.btn { padding: 10px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
.btn-add { background: var(--primary); color: white; }
.btn-receive { background: var(--receive-red); color: white; }
.btn-backup { background: #374151; color: white; }

.backup-restore-container { display: flex; gap: 10px; margin-bottom: 20px; }
.backup-restore-container .btn-backup { flex: 1; }

.add-new-section { margin-top: 30px; padding: 20px; background: #2c2c2c; border-radius: 12px; border: 2px dashed #4b5563; }
.bottom-spacer { height: 280px; }
</style>
</head>
<body>

<div id="management-app">
    <div class="header-row">
        <div class="header-title">AH Sweets ~ Ali Haider</div>
        <span id="privacy-toggle" onclick="togglePrivacy()">‚ö°</span>
    </div>

    <div class="search-container">
        <input type="text" id="customerSearch" oninput="searchCustomer()" placeholder="üîç Search Customers...">
        <div id="searchResults" class="search-results"></div>
    </div>

    <div id="alpha-nav" class="alpha-nav"></div>

    <div class="backup-restore-container">
        <button class="btn btn-backup" onclick="downloadBackupFile()">‚åõ Backup</button>
        <button class="btn btn-backup" onclick="document.getElementById('fileInput').click()">‚è≥ Restore</button>
        <input type="file" id="fileInput" style="display:none" accept=".txt" onchange="restoreFromFile(event)">
    </div>

    <div id="customer-list"></div>

    <div id="add-new-section" class="add-new-section">
        <h3 style="margin-top:0; font-size:1rem; color:var(--text-dark)">+ Add New Customer</h3>
        <input id="newCustomerName" type="text" placeholder="Customer Name" class="input-box" />
        <input id="newCustomerPhone" type="text" value="n" class="input-box" />
        <button class="btn btn-add" style="width:100%" onclick="addNewCustomer()">Create Account</button>
    </div>

    <div class="bottom-spacer"></div>
</div>

<script>
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); });

let customers = JSON.parse(localStorage.getItem('customers')) || [];
let lastUpdateInfo = JSON.parse(localStorage.getItem('lastUpdate')) || { name: "None", time: "" };
let isHidden = true; 
let singleViewId = null; 
const totalClickTracker = {};

function formatAmount(n) { return Number(n).toLocaleString('en-IN'); }

function save() {
    localStorage.setItem('customers', JSON.stringify(customers));
    localStorage.setItem('lastUpdate', JSON.stringify(lastUpdateInfo));
    updateUI();
}

function togglePrivacy() {
    isHidden = !isHidden;
    singleViewId = null; 
    document.getElementById('privacy-toggle').textContent = isHidden ? '‚ö°' : '‚ùå';
    updateUI();
}

function searchCustomer() {
    const query = document.getElementById('customerSearch').value.toLowerCase().trim();
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = '';
    
    if (query.length < 1) { 
        resultsDiv.style.display = 'none'; 
        return; 
    }

    const filtered = customers.filter(c => c.name.toLowerCase().includes(query));
    if (filtered.length > 0) {
        resultsDiv.style.display = 'block';
        filtered.forEach(c => {
            const row = document.createElement('div');
            row.textContent = c.name;
            row.onclick = () => {
                singleViewId = c.id; // Lock to the specific customer ID found
                isHidden = false; 
                document.getElementById('privacy-toggle').textContent = '‚ùå';
                resultsDiv.style.display = 'none';
                document.getElementById('customerSearch').value = '';
                updateUI();
            };
            resultsDiv.appendChild(row);
        });
    } else { resultsDiv.style.display = 'none'; }
}

function updateUI() {
    const total = customers.reduce((sum, c) => sum + c.total, 0);
    const div = document.getElementById('customer-list');
    const searchBar = document.getElementById('customerSearch');
    searchBar.placeholder = `üîç Search ${customers.length} Customers...`;
    
    div.innerHTML = '';
    // Always sort by name for alphabetical order
    customers.sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()));

    const nav = document.getElementById('alpha-nav');
    if (singleViewId || isHidden) { nav.style.display = 'none'; } 
    else {
        nav.style.display = 'flex';
        const activeLetters = [...new Set(customers.map(c => {
            let char = c.name.trim().charAt(0).toUpperCase();
            return /[A-Z]/.test(char) ? char : '#';
        }))].sort();
        nav.innerHTML = `<a href="#add-new-section" style="font-size: 18px; margin-bottom: 5px;">+</a>`;
        activeLetters.forEach(char => {
            const targetId = char === '#' ? 'letter-HASH' : `letter-${char}`;
            nav.innerHTML += `<a href="#${targetId}">${char}</a>`;
        });
    }

    let lastLetter = '';
    customers.forEach((c) => {
        // FIX: Strict check. If we are in single view, hide EVERYONE except the target ID.
        if (singleViewId !== null && c.id !== singleViewId) return;
        if (isHidden && singleViewId === null) return;

        let currentLetter = c.name.trim().charAt(0).toUpperCase();
        if (!/[A-Z]/.test(currentLetter)) currentLetter = '#';

        if (currentLetter !== lastLetter && singleViewId === null) {
            const anchorId = currentLetter === '#' ? 'letter-HASH' : `letter-${currentLetter}`;
            const totalDisplay = isHidden ? "~ ****" : `~ ${formatAmount(Math.round(total))}`;
            const summaryText = lastLetter === '' ? `<span class="total-credit-grey" ondblclick="showLastUpdate()">${totalDisplay}</span>` : '';
            div.innerHTML += `<div id="${anchorId}" class="letter-header"><span>${currentLetter}</span>${summaryText}</div>`;
            lastLetter = currentLetter;
        }

        div.innerHTML += `
            <div class="customer-box" id="cust-${c.id}">
                <div class="customer-name" ondblclick="editCustomer(${c.id})">${c.name}</div>
                <div class="total-amount" onclick="deleteTracker(${c.id})">${isHidden ? "Rs. ****" : "Rs. " + formatAmount(Math.round(c.total))}</div>
                <input type="number" id="input-${c.id}" class="input-box" placeholder="Enter amount">
                <div class="button-group">
                    <button class="btn btn-add" onclick="updateBill(${c.id}, 'add')">Add Bill</button>
                    <button class="btn btn-receive" onclick="updateBill(${c.id}, 'receive')">Receive</button>
                </div>
            </div>`;
    });

    if (singleViewId !== null) {
        div.innerHTML += `<button class="btn btn-backup" style="width:100%; margin-top:10px" onclick="clearSearch()">Show All Customers</button>`;
    }
}

function clearSearch() {
    singleViewId = null;
    updateUI();
}

function showLastUpdate() {
    alert(`Last Update: ${lastUpdateInfo.name}\nAt: ${lastUpdateInfo.time}`);
}

function addNewCustomer() {
    const nameInput = document.getElementById('newCustomerName');
    if (!nameInput.value.trim()) return;
    customers.push({ id: Date.now(), name: nameInput.value.trim(), phone: document.getElementById('newCustomerPhone').value.trim() || "n", total: 0 });
    save();
    nameInput.value = ''; document.getElementById('newCustomerPhone').value = 'n';
}

function updateBill(id, action) {
    const input = document.getElementById(`input-${id}`);
    const amt = parseFloat(input.value);
    if (!amt || amt <= 0) return;
    const c = customers.find(x => x.id === id);
    c.total += action === 'add' ? amt : -amt;
    const now = new Date();
    lastUpdateInfo = { name: c.name, time: `${now.toLocaleDateString()} ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}` };
    save(); downloadBackupFile();
    if (/^\d+$/.test(c.phone) && c.phone !== "0") {
        let msg = action === 'receive' ? 
            `Dear ${c.name},\nRs. ${formatAmount(amt)} has been received from your account at AH Sweets.\nYour updated bill is Rs. ${formatAmount(c.total)}` : 
            `Dear ${c.name},\nRs. ${formatAmount(amt)} has been added to your account at AH Sweets.\nYour updated bill is Rs. ${formatAmount(c.total)}`;
        window.open(`sms:+92${c.phone.startsWith('0')?c.phone.substring(1):c.phone}?body=${encodeURIComponent(msg)}`);
    }
}

function downloadBackupFile() {
    if (customers.length === 0) return;
    const backupText = `META|${lastUpdateInfo.name}|${lastUpdateInfo.time}\n` + customers.map(c => `${c.name},${c.phone},${c.total}`).join('\n');
    const dataUri = 'data:text/plain;charset=utf-8,' + encodeURIComponent(backupText);
    const now = new Date();
    const dd = String(now.getDate()).padStart(2, '0');
    const monthNames = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"];
    const mon = monthNames[now.getMonth()];
    let hh = now.getHours();
    const ampm = hh >= 12 ? 'p' : 'a';
    hh = hh % 12; hh = hh ? hh : 12; 
    const hStr = String(hh).padStart(2, '0');
    const min = String(now.getMinutes()).padStart(2, '0');
    const ss = String(now.getSeconds()).padStart(2, '0');
    const fileName = `Candy.${dd}.${mon}.${hStr}.${min}.${ss}.${ampm}.txt`;
    const link = document.createElement('a');
    link.setAttribute('href', dataUri); link.setAttribute('download', fileName);
    document.body.appendChild(link); link.click(); document.body.removeChild(link);
}

function restoreFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const lines = e.target.result.trim().split('\n');
        let start = 0;
        if (lines[0].startsWith("META|")) {
            const m = lines[0].split('|'); lastUpdateInfo = { name: m[1], time: m[2] }; start = 1;
        }
        customers = lines.slice(start).map(l => {
            const p = l.split(',');
            return { id: parseFloat(p[3]) || Date.now() + Math.random(), name: p[0], phone: p[1] || "n", total: parseFloat(p[2]) || 0 };
        });
        save();
    };
    reader.readAsText(file);
}

function deleteTracker(id) {
    const now = Date.now();
    const c = customers.find(x => x.id === id);
    if (!totalClickTracker[id]) { totalClickTracker[id] = { count: 1, time: now }; return; }
    if (now - totalClickTracker[id].time < 1500) totalClickTracker[id].count++;
    else totalClickTracker[id].count = 1;
    totalClickTracker[id].time = now;
    if (totalClickTracker[id].count >= 5) {
        if (confirm(`Delete ${c.name} ?`)) { 
            customers = customers.filter(cust => cust.id !== id); 
            singleViewId = null; // Reset view after delete
            save(); 
            downloadBackupFile(); 
        }
        totalClickTracker[id].count = 0;
    }
}

function editCustomer(id) {
    const c = customers.find(x => x.id === id);
    const n = prompt("Edit Name", c.name);
    const p = prompt("Edit Phone", c.phone);
    if (n !== null) { 
        c.name = n.trim() || c.name; 
        c.phone = p !== null ? p.trim() : c.phone; 
        save(); 
    }
}

updateUI();
</script>
</body>
</html>
