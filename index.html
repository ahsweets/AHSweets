<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>AH Sweets Management</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e1e1e">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
    --primary: #059669;
    --success: #FFC107;
    --bg: #1e1e1e;
    --card: #2c2c2c;
    --text-dark: #e5e7eb;
    --text-light: #9ca3af;
    --border: #374151;
    --receive-red: #ef4444;
}

body { 
    background-color: var(--bg); 
    margin: 0; 
    padding: 0; 
    display: flex; 
    justify-content: center;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

#management-app {
    font-family: 'Inter', sans-serif;
    color: var(--text-dark);
    max-width: 600px;
    width: 100%;
    margin: 10px 10px;
    padding: 15px;
    padding-right: 40px; 
    border-radius: 16px;
    box-sizing: border-box;
}

.header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.header-title { font-weight: 700; font-size: 1.1rem; color: var(--success); }

.search-container {
    position: sticky;
    top: 0;
    z-index: 1001;
    background: var(--bg);
    padding: 5px 0 10px 0;
}

#customerSearch {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--border);
    border-radius: 10px;
    background: #2c2c2c;
    color: white;
    font-size: 1rem;
    box-sizing: border-box;
    -webkit-user-select: text;
    user-select: text;
}

.search-results {
    background: #333;
    border-radius: 0 0 10px 10px;
    max-height: 250px;
    overflow-y: auto;
    display: none;
    border: 1px solid var(--border);
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}

.search-results div { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; color: var(--success); }

.alpha-nav {
    position: fixed;
    right: 2px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    z-index: 1000;
    background: rgba(30, 30, 30, 0.85);
    padding: 5px 0;
    border-radius: 10px;
    max-height: 90vh;
    overflow-y: auto;
}

.alpha-nav a { font-size: 11px; color: var(--success); padding: 1px 6px; text-decoration: none; text-align: center; font-weight: 700; display: block; line-height: 1.4; }

.letter-header {
    color: var(--success);
    font-size: 1.2rem;
    font-weight: 800;
    padding: 10px 0 5px 0;
    border-bottom: 1px solid var(--border);
    margin-top: 15px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: row;
    align-items: center;
}

.total-credit-grey {
    color: #888;
    font-size: 1rem;
    font-weight: 500;
    margin-left: 8px;
    cursor: pointer;
}

.customer-box { background: var(--card); padding: 18px; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); scroll-margin-top: 150px; position: relative; }
.customer-name { font-weight: 700; font-size: 1.1rem; color: var(--text-dark); cursor: pointer; }
.total-amount { font-weight: 800; font-size: 1.3rem; color: var(--success); margin: 5px 0; display: block; cursor: pointer; }

.cust-id-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 10px;
    background: #4b5563;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
}

.input-box { 
    width: 100%; 
    padding: 10px; 
    border: 1px solid var(--border); 
    border-radius: 8px; 
    margin: 10px 0; 
    font-size: 1rem; 
    box-sizing: border-box; 
    background: #2c2c2c; 
    color: var(--text-dark);
    -webkit-user-select: text;
    user-select: text;
}

.button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

.btn { padding: 10px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
.btn-add { background: var(--primary); color: white; }
.btn-receive { background: var(--receive-red); color: white; }
.btn-backup { background: #374151; color: white; }

.add-new-section { margin-top: 30px; padding: 20px; background: #2c2c2c; border-radius: 12px; border: 2px dashed #4b5563; }
.bottom-spacer { height: 280px; }
</style>
</head>
<body oncontextmenu="return false;">

<div id="management-app">
    <div class="header-row">
        <div class="header-title">AH Sweets ~ Ali Haider</div>
    </div>

    <div class="search-container">
        <input type="text" id="customerSearch" oninput="searchCustomer()" placeholder="üîç Search Customers..." autocomplete="off" spellcheck="false" autocapitalize="off">
        <div id="searchResults" class="search-results"></div>
    </div>

    <div id="alpha-nav" class="alpha-nav"></div>

    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button class="btn btn-backup" style="flex:1" onclick="downloadBackupFile()">‚åõ Backup</button>
        <button class="btn btn-backup" style="flex:1" onclick="document.getElementById('fileInput').click()">‚è≥ Restore</button>
        <input type="file" id="fileInput" style="display:none" onchange="restoreFromFile(event)">
    </div>

    <div id="customer-list"></div>

    <div id="add-new-section" class="add-new-section">
        <h3 style="margin-top:0; font-size:1rem; color:var(--text-dark)">+ Add New Customer</h3>
        <input id="newCustomerName" type="text" placeholder="Customer Name" class="input-box" autocomplete="off" />
        <input id="newCustomerPhone" type="text" value="n" class="input-box" autocomplete="off" />
        <button class="btn btn-add" style="width:100%" onclick="addNewCustomer()">Create Account</button>
    </div>

    <div class="bottom-spacer"></div>
</div>

<script>
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); });

let customers = JSON.parse(localStorage.getItem('customers')) || [];
let lastUpdateInfo = JSON.parse(localStorage.getItem('lastUpdate')) || { name: "None", time: "" };
let singleViewId = null; 
const totalClickTracker = {};

function formatAmount(n) { return Number(n).toLocaleString('en-IN'); }

function save() {
    localStorage.setItem('customers', JSON.stringify(customers));
    localStorage.setItem('lastUpdate', JSON.stringify(lastUpdateInfo));
    updateUI();
}

function searchCustomer() {
    const query = document.getElementById('customerSearch').value.toLowerCase().trim();
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = '';
    
    if (query.length < 1) { 
        resultsDiv.style.display = 'none'; 
        return; 
    }

    const filtered = customers.filter(c => c.name.toLowerCase().includes(query));
    if (filtered.length > 0) {
        resultsDiv.style.display = 'block';
        filtered.forEach(c => {
            const row = document.createElement('div');
            row.textContent = c.name;
            row.onclick = () => {
                singleViewId = c.id; 
                resultsDiv.style.display = 'none';
                document.getElementById('customerSearch').value = '';
                updateUI();
            };
            resultsDiv.appendChild(row);
        });
    } else { resultsDiv.style.display = 'none'; }
}

function showHistory(id) {
    const c = customers.find(x => x.id === id);
    if (!c.history || c.history.length === 0) {
        alert("No history available for " + c.name);
        return;
    }
    let historyHtml = c.history.map((h, index) => {
        const bgColor = index % 2 === 0 ? '#374151' : '#2c2c2c';
        return `<div style="background:${bgColor}; padding:10px; border-radius:8px; margin-bottom:8px; border:1px solid #444;">
            <div style="font-weight:700; color:#FFC107; font-size:0.9rem;">${h.type} :- ${formatAmount(h.val)}</div>
            <div style="color:#e5e7eb; font-size:0.85rem; margin:2px 0;">Total Bill :- ${formatAmount(h.total)}</div>
            <div style="color:#9ca3af; font-size:0.75rem;">${h.date}</div>
        </div>`;
    }).join('');

    const overlay = document.createElement('div');
    overlay.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:2000; display:flex; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;";
    overlay.onclick = () => document.body.removeChild(overlay);

    const modal = document.createElement('div');
    modal.style = "background:#1e1e1e; padding:15px; border-radius:15px; width:100%; max-width:400px; border:2px solid #FFC107; max-height:80vh; overflow-y:auto;";
    modal.onclick = (e) => e.stopPropagation();
    modal.innerHTML = `<h3 style="color:#FFC107; margin:0 0 15px 0; text-align:center;">History: ${c.name}</h3>` + historyHtml + `<button class="btn btn-backup" style="width:100%; margin-top:10px;">Close</button>`;
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
}

function updateUI() {
    const total = customers.reduce((sum, c) => sum + c.total, 0);
    const div = document.getElementById('customer-list');
    const searchBar = document.getElementById('customerSearch');
    searchBar.placeholder = `üîç Search ${customers.length} Customers...`;
    
    div.innerHTML = '';
    customers.sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()));

    const nav = document.getElementById('alpha-nav');
    if (singleViewId) { nav.style.display = 'none'; } 
    else {
        nav.style.display = 'flex';
        const activeLetters = [...new Set(customers.map(c => {
            let char = c.name.trim().charAt(0).toUpperCase();
            return /[A-Z]/.test(char) ? char : '#';
        }))].sort();
        nav.innerHTML = `<a href="#add-new-section" style="font-size: 18px; margin-bottom: 5px;">+</a>`;
        activeLetters.forEach(char => {
            const targetId = char === '#' ? 'letter-HASH' : `letter-${char}`;
            nav.innerHTML += `<a href="#${targetId}">${char}</a>`;
        });
    }

    let lastLetter = '';
    let usedIds = new Set();
    let currentHTML = '';

    customers.forEach((c) => {
        if (singleViewId !== null && c.id !== singleViewId) return;

        let currentLetter = c.name.trim().charAt(0).toUpperCase();
        if (!/[A-Z]/.test(currentLetter)) currentLetter = '#';

        if (currentLetter !== lastLetter && singleViewId === null) {
            const anchorId = currentLetter === '#' ? 'letter-HASH' : `letter-${currentLetter}`;
            const totalDisplay = `~ ${formatAmount(Math.round(total))}`;
            const summaryText = lastLetter === '' ? `<span class="total-credit-grey" ondblclick="showLastUpdate()">${totalDisplay}</span>` : '';
            currentHTML += `<div id="${anchorId}" class="letter-header"><span>${currentLetter}</span>${summaryText}</div>`;
            lastLetter = currentLetter;
        }

        let randId;
        do { randId = Math.floor(1000 + Math.random() * 9000); } while (usedIds.has(randId));
        usedIds.add(randId);

        currentHTML += `
            <div class="customer-box" id="cust-${c.id}">
                <div class="cust-id-btn" onclick="showHistory(${c.id})">ID: #${randId}</div>
                <div class="customer-name" ondblclick="editCustomer(${c.id})">${c.name}</div>
                <div class="total-amount" onclick="deleteTracker(${c.id})">Rs. ${formatAmount(Math.round(c.total))}</div>
                <input type="number" id="input-${c.id}" class="input-box" placeholder="Enter amount">
                <div class="button-group">
                    <button class="btn btn-add" onclick="updateBill(${c.id}, 'add')">Add Bill</button>
                    <button class="btn btn-receive" onclick="updateBill(${c.id}, 'receive')">Receive</button>
                </div>
            </div>`;
    });

    div.innerHTML = currentHTML;

    if (singleViewId !== null) {
        div.innerHTML += `<button class="btn btn-backup" style="width:100%; margin-top:10px" onclick="clearSearch()">Show All Customers</button>`;
    }
}

function clearSearch() {
    singleViewId = null;
    updateUI();
}

function showLastUpdate() {
    alert(`Last Update: ${lastUpdateInfo.name}\nAt: ${lastUpdateInfo.time}`);
}

function addNewCustomer() {
    const nameInput = document.getElementById('newCustomerName');
    if (!nameInput.value.trim()) return;
    customers.push({ id: Date.now(), name: nameInput.value.trim(), phone: document.getElementById('newCustomerPhone').value.trim() || "n", total: 0, history: [] });
    save();
    nameInput.value = ''; document.getElementById('newCustomerPhone').value = 'n';
}

function updateBill(id, action) {
    const input = document.getElementById(`input-${id}`);
    const amt = parseFloat(input.value);
    if (!amt || amt <= 0) return;
    const c = customers.find(x => x.id === id);
    c.total += action === 'add' ? amt : -amt;
    
    const now = new Date();
    const dateStr = now.toLocaleDateString() + " " + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: true});
    
    if(!c.history) c.history = [];
    c.history.unshift({
        type: action === 'add' ? "Add money" : "Receive money",
        val: amt,
        total: c.total,
        date: dateStr
    });
    if(c.history.length > 5) c.history.pop();

    lastUpdateInfo = { name: c.name, time: dateStr };
    save(); 
    downloadBackupFile();
    
    if (/^\d+$/.test(c.phone) && c.phone !== "0") {
        let msg = action === 'receive' ? 
            `Dear ${c.name},\nRs. ${formatAmount(amt)} has been received from your account at AH Sweets.\nYour updated bill is Rs. ${formatAmount(c.total)}` : 
            `Dear ${c.name},\nRs. ${formatAmount(amt)} has been added to your account at AH Sweets.\nYour updated bill is Rs. ${formatAmount(c.total)}`;
        window.open(`sms:+92${c.phone.startsWith('0')?c.phone.substring(1):c.phone}?body=${encodeURIComponent(msg)}`);
    }
}

function downloadBackupFile() {
    if (customers.length === 0) return;
    const backupObj = {
        M: { N: lastUpdateInfo.name, T: lastUpdateInfo.time },
        D: customers.map(c => ({
            C: c.name,
            P: c.phone,
            T: c.total,
            H: c.history || [],
            I: c.id
        }))
    };
    const now = new Date();
    const monthNames = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"];
    const day = String(now.getDate()).padStart(2, '0');
    const month = monthNames[now.getMonth()];
    const hours = String(now.getHours()).padStart(2, '0');
    const mins = String(now.getMinutes()).padStart(2, '0');
    const secs = String(now.getSeconds()).padStart(2, '0');
    const ampm = now.getHours() >= 12 ? 'pm' : 'am';
    
    const fileName = `Candy.${day}.${month}.${hours}.${mins}.${secs}.${ampm}.json`;
    
    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(backupObj));
    const link = document.createElement('a');
    link.setAttribute('href', dataUri); link.setAttribute('download', fileName);
    document.body.appendChild(link); link.click(); document.body.removeChild(link);
}

function restoreFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if (data.M) lastUpdateInfo = { name: data.M.N, time: data.M.T };
            customers = data.D.map(item => ({
                id: item.I || Date.now() + Math.random(),
                name: item.C,
                phone: item.P,
                total: item.T,
                history: item.H || []
            }));
            save();
        } catch (err) { alert("Invalid backup format."); }
    };
    reader.readAsText(file);
}

function deleteTracker(id) {
    const now = Date.now();
    const c = customers.find(x => x.id === id);
    if (!totalClickTracker[id]) { totalClickTracker[id] = { count: 1, time: now }; return; }
    if (now - totalClickTracker[id].time < 1500) totalClickTracker[id].count++;
    else totalClickTracker[id].count = 1;
    totalClickTracker[id].time = now;
    if (totalClickTracker[id].count >= 5) {
        if (confirm(`Delete ${c.name} ?`)) { 
            customers = customers.filter(cust => cust.id !== id); 
            singleViewId = null; 
            save(); 
            downloadBackupFile(); 
        }
        totalClickTracker[id].count = 0;
    }
}

function editCustomer(id) {
    const c = customers.find(x => x.id === id);
    const n = prompt("Edit Name", c.name);
    const p = prompt("Edit Phone", c.phone);
    if (n !== null) { 
        c.name = n.trim() || c.name; 
        c.phone = p !== null ? p.trim() : c.phone; 
        save(); 
    }
}

updateUI();
</script>
</body>
</html>
